---
title: "mytilus_nucella"
author: "Tena Dhayalan"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: cosmo
    toc: yes
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning=FALSE, 
                      message=FALSE)
```

### Loading libraries

```{r,echo=FALSE, message=FALSE}
library(dplyr)
library(broom)
library(purrr)
library(lubridate)
library(tidyverse)
library(nlstools)
library(here)
library(stringr)
library(lmerTest)
library(lme4)
library(knitr)
require(kableExtra)
library(tidyverse)
library(car)
library(patchwork)
library(seacarb)
options(knitr.table.format = "html")
```

### Load data

```{r,echo=FALSE, message=FALSE}
calc <- read_csv(here("Data", "TA", "NEC.csv")) # calcification 
shell_calc <- read.csv(here("Data","TA","shell_NEC.csv"))
tankpH <- read_csv(here("Data", "pH_temp", "ph_temp_final_cut.csv.")) # ph and temp data
respo <- read_csv(here("Data", "PR_2024", "PR_final_normalized_dry.csv")) # respo
Sample.Info <- read_csv(here("Data", "PR_2024", "Metadata.csv")) # respo metadata
mussel_initial <- read_csv(here("Data", "growth", "mytilus_initial.csv")) # initial mussel measurements
mussel_final <- read_csv(here("Data", "afdw", "mussel_afdw.csv")) # final mussel measurements
nucella_initial <- read_csv(here("Data", "growth", "nucella_initial.csv")) # initial nucella measurements
nucella_final <- read_csv(here("Data", "afdw", "nucella_afdw.csv")) # final nucella measurements
mortality <- read_csv(here("Data","mytilus_mortality.csv")) # mussel mortality
hungry_whelks <- read_csv(here("Data","whelk_hungry.csv"))
musselrespo_trimmed <- read_csv(here("Data", "PR_2024", "PR_final_normalized_dry_test.csv")) 
quadrat <- read_csv(here("Data", "field", "quadrat.csv"))
temp <- read.csv(here("Data","field","san_pedro_temp_buoy.csv")) #https://data.caloos.org/#metadata/103471/station/data
fulltemp <- read.csv(here("Data","field","full_san_pedro_temp_buoy.csv")) 
TA <- read.csv(here("Data","TA","background_TA","background_TA.csv"))
carb <- read.csv(here("Data", "pH_temp", "carb.csv"))
```

## carb data
```{r}
# carb <- carb(8, var1 = TA$pH, var2 = TA$TA, S = TA$Salinity_lab, T = TA$TempInSitu, pHscale = "T")

# carb <- carb %>%
 # left_join(TA)

# write.csv(carb, here("Data/pH_temp/carb.csv"))

# calculate means and sds for each column
carb_summary <- carb %>%
  group_by(tank) %>%
  summarise(
    across(where(is.numeric),
           list(mean = ~mean(.x, na.rm = TRUE),
                sd = ~sd(.x, na.rm = TRUE)),
           .names = "{.col}_{.fn}") 
  )

# reformat so mean and sd are in the same column
carb_summary <- carb_summary %>%
  rowwise() %>%
  mutate(
    across(
      ends_with("_mean"),
      ~ {
        base <- sub("_mean$", "", cur_column())
        mean_val <- .x
        sd_val <- get(paste0(base, "_sd"))
        sprintf("%.2f ± %.2f", mean_val, sd_val)
      },
      .names = "{.col}_formatted"
    )
  ) %>%
  ungroup() %>%
  select(tank, ends_with("_formatted"))

write.csv(carb_summary, here("Data/pH_temp/carb_summary.csv"))
```


## Add tank data

```{r}
tankpHavg <- aggregate(cbind(pH,TempInSitu) ~ tank, data = tankpH, FUN = mean) # calculate avg pHs per tank

tankpH %>%
  ggplot(aes(x=expected_pH, y= pH, group = expected_pH, color = expected_pH))+
  geom_boxplot(width=0.1, outlier.alpha = 0.1)+
  scale_color_gradient(low = "#ffc43d", high = "#06d6a0")+
  theme_bw()+
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 16)) +
  theme(legend.position = "none") +
  labs(x = expression(paste("Target pH"[T])), 
       y = expression(paste("Average tank pH"[T])), 
       color = "")

respo <-
  respo %>%
  left_join(tankpHavg, by = "tank") %>%
  mutate(temp_treatment = as.factor(temp_treatment))

tankpH %>%
  ggplot(aes(x=as.factor(expected_temp), y= TempInSitu, group = expected_temp, color = as.factor(expected_temp)))+
  geom_boxplot(width = 0.5, outlier.alpha = 0.1)+
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 16)) +
  theme(legend.position = "none") +
  labs(x = expression(paste("Target temperature ",degree,"C")),
       y = expression(paste("Average tank temperature ",degree,"C")), 
       color = "")
```

# field

```{r}
states<-map_data("state") #all state coordinates
ca_data <- states %>%
  filter(region == "california") #just filter out california

ggplot()+
  geom_polygon(data = ca_data,
               aes(x=long, y=lat, group = group), color = "black")+
  geom_point(aes(x = -118.319, y = 33.715), color= "blue", size = 5)+
  coord_map()+
  theme_void()
```

## field temp
```{r}
# calculate weekly averages
temp <- temp %>%
  mutate(date = as.Date(date, format="%m/%d/%Y")) # adjust date format

temp <- temp %>%
  group_by(week = floor_date(date, "week")) %>%  # groups by week
  mutate(weekly_avg = mean(sea_water_temperature, na.rm = TRUE))  # computes weekly mean

# calculate loess model
collection_dates <- as.Date(c("2024-07-07"))
loess_fit <- loess(sea_water_temperature ~ as.numeric(date), data = temp)
collections <- data.frame(date = collection_dates,
  loess_fitted = predict(loess_fit, newdata = as.numeric(collection_dates)))

temp %>%
  ggplot(aes(x = as.factor(date), y = sea_water_temperature)) +
  geom_smooth(aes(x = date, y = weekly_avg),method = "loess", color = "salmon4", size = 1)+
  geom_point(aes(x = date, y = sea_water_temperature), color = "salmon4", alpha = 0.1) +
  #geom_point(data = collections, aes(x= date, y = loess_fitted), color = "salmon", size = 4) +  # LOESS y values
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 20),
    legend.position = "none") +
    labs(x = expression(Date),
    y = expression(paste("Temperature ",degree,"C"))
  ) 

# calculate percent of time above 22? 3%

fulltemp %>%
  mutate(sea_water_temperature = as.numeric(sea_water_temperature)) %>%
  filter(!is.na(sea_water_temperature)) %>%
  summarise(prop_above_22 = mean(sea_water_temperature > 22))

```

## quadrat and initial data
```{r}
# mussel size distribution
quadrat %>%
  filter(species == "mussel") %>%
  ggplot(aes(x=shell_length)) + 
  geom_histogram(position="dodge",bins=7,color="white", fill="steelblue4")+
  theme_bw() + theme(axis.text = element_text(size=18),axis.title = element_text(size=20))+
  labs(x="Shell length (mm)", y="Observations")

summary(mussel_initial) # min and max of collected mussels

# whelk size distribution
quadrat %>%
  filter(species == "whelk") %>%
  ggplot(aes(x=shell_length)) + 
  geom_histogram(position="dodge",bins=7,color="white", fill="lightgoldenrod2")+
  theme_bw() + theme(axis.text = element_text(size=18),axis.title = element_text(size=20))+
  labs(x="Shell length (mm)", y="Observations")

summary(nucella_initial) # min and max of collected whelks

# scale up quadrat data to be per m^2
## whelks/0.25m^2, so multiply by 4
## mussels/0.0625m^2 so multiply by 16
quadrat <- quadrat %>%
  mutate(density_m2 = ifelse(species == "whelk", density * 4, density * 16)) 
  

# whelks in beds
quadrat %>%
  filter(species == "whelk") %>% # keep only whelk data
  distinct(transect, meter, .keep_all = TRUE) %>%  # <- remove duplicates
  ggplot(aes(x = 0, y=density_m2)) + 
    geom_dotplot(binaxis='y', stackdir='center', alpha = 0.1)+
    theme_bw()+
    stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), geom="pointrange", color="black", size = 1)+
    labs(y = expression("Whelk density per m"^2))+
    theme(axis.text = element_text(size=18),axis.title = element_text(size=20), 
          axis.text.x = element_blank(), axis.title.x = element_blank())

# mussels
quadrat %>%
  filter(species == "mussel") %>% # keep only mussel data
  distinct(transect, meter, .keep_all = TRUE) %>%  # <- remove duplicates
  ggplot(aes(x = 0, y=density_m2)) + 
    geom_dotplot(binaxis='y', stackdir='center', alpha = 0.1)+
    theme_bw()+
    stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), geom="pointrange", color="black", size = 1)+
    labs(y = expression("Mussel density per m"^2))+
    theme(axis.title = element_text(size = 20), axis.text = element_text(size = 18), 
          axis.text.x = element_blank(), axis.title.x = element_blank())
```


# Mussels

## Mussel growth - almost an interaction

```{r}
musselrespo <- respo %>%
  filter(Species == "Mussel", !ID == "Shell") # filter just mussel data

musselgrowth <- musselrespo %>%
  mutate(ID = as.numeric(ID)) %>%
  left_join(mussel_initial %>%
            filter(cage == "ctrl"), by = c("ID", "tank")) %>% # bring in mussel initial wet weight with final
  left_join(mussel_final, by = "ID")

musselgrowth <- musselgrowth %>%
  mutate(weight_change = (wet_weight - wet_weight_initial)/wet_weight_initial) # create column for change in weight

musselweight <- lm(weight_change ~ pH * temp_treatment, data=musselgrowth) # model
#plot(musselweight)
anova(musselweight) # nothing sig

# plot
musselweight %>% 
  ggplot(aes(x = pH, y = weight_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔWeight(g))
  )

musselgrowth_avg <- musselgrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_weight_change = mean(weight_change, na.rm = TRUE)  # calculate mean growth rate
  )

musselweight_avg <- lm(avg_weight_change ~ pH * temp_treatment, data=musselgrowth_avg) # model
#plot(musselweight)
anova(musselweight) # nothing sig

musselweightplot <-
musselweight_avg %>% 
  ggplot(aes(x = pH, y = avg_weight_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(aes(shape = temp_treatment),alpha = 0.5)+
  #geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    shape = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔWeight)
  )

```

## Mussel shell growth - nothing

```{r}
musselgrowth <- musselgrowth %>%
  mutate(length_change = (shell_length - shell_length_initial)/shell_length_initial) %>%
  mutate(width_change = (shell_width - shell_width_initial)/shell_width_initial) %>%
  mutate(depth_change = (shell_depth - shell_depth_initial)/shell_depth_initial) 

musselgrowth_avg <- musselgrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    length_change = mean(length_change, na.rm = TRUE),   # calculate mean growth rate
    width_change = mean(width_change, na.rm = TRUE)
  )

# shell length most often reported

mshellmodelL <- lm(length_change ~ pH * temp_treatment, data = musselgrowth_avg)
#plot(mshellmodelL)
anova(mshellmodelL) # not sig

mussellengthplot <-
mshellmodelL %>% 
  ggplot(aes(x = pH, y = length_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(aes(shape = temp_treatment),alpha = 0.5)+
  #geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    shape = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔShell~length)
  )

# shell width

mshellmodelW <- lm(width_change ~ pH * temp_treatment, data = musselgrowth_avg)
#plot(mshellmodelW)
anova(mshellmodelW) # not sig

musselwidthplot <-
mshellmodelW %>% 
  ggplot(aes(x = pH, y = width_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(aes(shape = temp_treatment),alpha = 0.5)+
  #geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    shape = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔShell~width)
  )

# shell depth 
mshellmodelD <- lm(depth_change ~ pH * temp_treatment, data = musselgrowth)
#plot(mshellmodelD)
anova(mshellmodelD) # not sig

mshellmodelD %>% 
  ggplot(aes(x = pH, y = depth_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔShell~depth(mm))
  )
```

## Mussel Condition Index - nothing

```{r}
musselgrowth$CI <- musselgrowth$AFDW/musselgrowth$dry_shell*100
mCImodel <- lm(CI ~ pH * temp_treatment, data = musselgrowth)
#plot(mCImodel)
anova(mCImodel)

mCImodel %>% 
  ggplot(aes(x = pH, y = CI, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(Condition~Index)
  )

# averages
musselgrowth <- musselgrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_CI = mean(CI, na.rm = TRUE)  # calculate mean growth rate
  )

mCImodel_avg <- lm(avg_CI ~ pH * temp_treatment, data=musselgrowth) # model
#plot(musselweight)
anova(mCImodel_avg) # nothing sig

musselCIplot <-
mCImodel_avg %>% 
  ggplot(aes(x = pH, y = avg_CI, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(aes(shape = temp_treatment),alpha = 0.5)+
  #geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    shape = expression(paste("Temperature ",degree,"C")),
    y = expression(Condition~Index)
  )
```

## Mussel calcification - pH significant at low temperature (but likely driven by those low points)
```{r}
mussel_calc <- calc %>%
  filter(Species == "Mussel") %>%
  mutate(ID = as.factor(ID)) %>%
  left_join(musselrespo %>%
              select(tank, pH) %>%
              distinct(),
              by = "tank") %>%
  mutate(temp_treatment = as.factor(temp_treatment))

summary(mussel_calc) # get range of values

# what percent were dissolving?
mussel_calc %>%
  summarise(prop_dissolve = mean(umol.cm2.hr < 0))

Mcalc_lm <- lm(umol.cm2.hr ~ wet_weight, data=calc)
summary(Mcalc_lm) # wet weight does not predict calc

# model calc 
Mcalcmodel <- lm(umol.cm2.hr ~ pH * temp_treatment, data = mussel_calc)
#plot(Mcalcmodel)
anova(Mcalcmodel) # pH sig

# normal plot
Mcalcmodel %>%
  ggplot(aes(x=pH, y=umol.cm2.hr, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
 # geom_smooth(method = "lm") +
  geom_point(alpha = 0.5)+
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       y = expression(Calcification~rate~(CaCO[3]~g^-1~hr^-1)))

# average
mussel_calc_avg <- mussel_calc %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_calc = mean(umol.cm2.hr , na.rm = TRUE)  # calculate mean calc rate
  )

mCalcmodel_avg <- lm(avg_calc ~ pH * temp_treatment, data=mussel_calc_avg) # model
#plot(musselweight)
anova(mCalcmodel_avg) # nothing sig

# average plot
Mcalcplot <-
mussel_calc_avg %>%
  ggplot(aes(x=pH, y=avg_calc, color = temp_treatment, fill= temp_treatment))+
  geom_point(alpha = 1, size = 2, aes(shape = temp_treatment))+
  # geom_smooth(method = "lm") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 18)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       shape = expression(paste("Temperature ",degree,"C")),
       y = expression(Calcification~rate~(mu*mol~CaCO[3]~g^-1~hr^-1)))

```

### Mussel shell calcification
```{r}
mussel_shell_calc <- shell_calc %>%
  filter(Species == "Mussel") %>%
  group_by(pH_treatment, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_calc = mean(umol.cm2.hr, na.rm = TRUE)  # calculate mean growth rate
  )

mshellcalcmodel_avg <- lm(avg_calc ~ pH_treatment * temp_treatment, data=mussel_shell_calc) # model
#plot(mshellcalcmodel_avg)
anova(mshellcalcmodel_avg) # nothin sig

Mshellplot <-
mshellcalcmodel_avg %>% 
  ggplot(aes(x = pH_treatment, y = avg_calc, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(aes(shape = as.factor(temp_treatment)), alpha = 0.5)+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    shape = expression(paste("Temperature ",degree,"C")),
    y = expression(Calcification~rate~(mu*mol~CaCO[3]~hr^-1)))

```

## Mussel wet to dry - bad

```{r}
musselreg <- lm(AFDW ~ wet_weight, data=musselrespo) # how well does wet weight predict afdw?

summary(musselreg) # r^2 = 0.5

musselreg %>% 
  ggplot(aes(x = wet_weight, y = AFDW)) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
    labs(
    x = expression(wet~weight),
    y = "AFDW")
```

## Mussel respo - nothing
```{r}
# check if weight is driving respo
musrespoweight <- lm(Respiration ~ AFDW, data=musselrespo) # does AFDW predict respiration rate?
#plot(musrespoweight)
musselrespo <- musselrespo %>%
  mutate(model = predict(musrespoweight))
anova(musrespoweight) # weight significant

summary(musselrespo) # get avgs

musselrespo %>%
  ggplot(aes(x=AFDW, y=Respiration))+
  stat_summary(aes(color = as.factor(temp_treatment)), 
               fun.data = mean_se, fun.args = list(mult = 1), size = 0.5) +
  geom_line(aes(y = model)) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00"))+ 
  labs(x = expression(Dry~Weight~(g)),
      color = expression(paste("Temperature ",degree,"C")),
      fill = expression(paste("Temperature ",degree,"C")),
      y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))

# add size as a covariate
musselresmodel <- lm(Respiration ~ pH * temp_treatment + AFDW, data = musselrespo)
#plot(musselresmodel)
anova(musselresmodel)

musselresmodel %>%
  ggplot(aes(x=pH, y=Respiration, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))

# averages
musselrespo_average <- musselrespo %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_respo = mean(Respiration , na.rm = TRUE)  # calculate mean respo rate
  )

mresmodel_avg <- lm(avg_respo ~ pH * temp_treatment, data=musselrespo_average) # model
#plot(musselweight)
anova(mresmodel_avg) # nothing sig

# average plot
Mrespoplot <-
mresmodel_avg %>%
  ggplot(aes(x=pH, y=avg_respo, color = temp_treatment, fill = temp_treatment))+
  geom_point(alpha = 1, size = 2, aes(shape = temp_treatment))+
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 18)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       shape = expression(paste("Temperature ",degree,"C")),
       y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))
```

### Respo trim test

```{r}
musselrespo_trimmed <- musselrespo_trimmed %>%
  filter(Species == "Mussel") %>%
  mutate(temp_treatment = as.factor(temp_treatment))

musselrespotrimtest <- bind_rows(list(a = musselrespo, b = musselrespo_trimmed), .id = "id")

t.test(Respiration ~ id, data = musselrespotrimtest)
```

## C:R

```{r}
mussel_avg <- mussel_calc_avg %>%
  left_join(musselrespo_average)

mussel_avg %>%
  ggplot(aes(x = avg_calc, y = avg_respo, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(Calcification~rate~(mu*mol~CaCO[3]~g^-1~hr^-1)),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))
```

# Nucella

## Nucella growth - almost temp

```{r}
nucellarespo <- respo %>%
  filter(Species == "Nucella", !ID == "Shell") # filter just nucella data

nucellagrowth <- nucellarespo %>%
  mutate(ID = as.numeric(ID)) %>%
  left_join(nucella_initial %>%
              dplyr::select(c("ID", "wet_weight_initial", "shell_length_initial", "shell_width_initial")), by = c("ID")) %>% # bring in nucella initial wet weight and shell measurements
  left_join(nucella_final %>%
              dplyr::select(c("ID", "dry_weight", "shell_length", "shell_width", "shell_growth", "dry_shell")), by = "ID") # bring in dry weight and final shell measurements

nucellagrowth <- nucellagrowth %>%
  mutate(weight_change = (wet_weight - wet_weight_initial)/wet_weight_initial) # create column for change in wet weight

nucellaweight <- lm(weight_change ~ pH * temp_treatment, data=nucellagrowth) # model
#plot(nucellaweight)
anova(nucellaweight) # almost temp effect

# plot
nucellaweight %>% 
  ggplot(aes(x = pH, y = weight_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔWeight(g))
  )

# average
nucellagrowth_avg <- nucellagrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_growth = mean(weight_change , na.rm = TRUE)  # calculate mean growth rate
  )

ngrowth_avg <- lm(avg_growth ~ pH * temp_treatment, data=nucellagrowth_avg) # model
#plot(musselweight)
anova(ngrowth_avg) # nothing sig

# average plot
ngrowth_avg %>%
  ggplot(aes(x=pH, y=avg_growth, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       y = expression(ΔWeight(g)))
```

## Nucella shell growth - temp effect!

```{r}
nucellagrowth <- nucellagrowth %>%
  mutate(length_change = (shell_length - shell_length_initial)/shell_length_initial) %>%
  mutate(width_change = (shell_width - shell_width_initial)/shell_width_initial) %>%
  mutate(NP_change = (shell_growth/shell_width_initial))

# shell length 

nshellmodelL <- lm(length_change ~ pH * temp_treatment, data = nucellagrowth)
#plot(nshellmodelL)
anova(nshellmodelL) # temp sig

nshellmodelL %>% 
  ggplot(aes(x = pH, y = length_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔShell~length~(mm))
  )

# average
nucellagrowth_avg <- nucellagrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_shellL = mean(length_change , na.rm = TRUE)  # calculate mean growth rate
  )

nshellL_avg <- lm(avg_shellL ~ pH * temp_treatment, data=nucellagrowth_avg) # model
#plot(musselweight)
anova(nshellL_avg) # nothing sig

# average plot
nshellL_avg %>%
  ggplot(aes(x=pH, y=avg_shellL, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       y =  expression(ΔShell~length~(mm)))

# shell width

nshellmodelW <- lm(width_change ~ pH * temp_treatment, data = nucellagrowth)
#plot(nshellmodelW)
anova(nshellmodelW) # temp sig

nshellmodelW %>% 
  ggplot(aes(x = pH, y = width_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔShell~width~(mm))
  )

# average
nucellagrowth_avg <- nucellagrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_shellW = mean(width_change , na.rm = TRUE)  # calculate mean growth rate
  )

nshellW_avg <- lm(avg_shellW ~ pH * temp_treatment, data=nucellagrowth_avg) # model
#plot(musselweight)
anova(nshellW_avg) # temp significant

# average plot
nshellW_avg %>%
  ggplot(aes(x=pH, y=avg_shellW, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       y =  expression(ΔShell~width~(mm)))
       
# shell growth estimated using nail polish

nshellmodelNP <- lm(NP_change ~ pH * temp_treatment, data = nucellagrowth)
# plot(nshellmodelNP)
anova(nshellmodelNP) # temp treatment

nshellmodelNP %>% 
  ggplot(aes(x = pH, y = NP_change, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(ΔShell~growth~(mm)))

nucellagrowth_avg <- nucellagrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_shellG = mean(NP_change , na.rm = TRUE)  # calculate mean growth rate
  )

nshellG_avg <- lm(avg_shellG ~ pH * temp_treatment, data=nucellagrowth_avg) # model
#plot(nShellG_avgna)
anova(nshellG_avg) # temp significant

# average plot
nshellG_avg %>%
  ggplot(aes(x=pH, y=avg_shellG, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       y =  expression(ΔShell~growth~(mm)))

# without pH
shellgrowthplot <-
nshellG_avg %>% 
  ggplot(aes(x =temp_treatment , y = avg_shellG)) +
  geom_boxplot(alpha=0.5, outlier.alpha=0) + 
  geom_jitter(aes(fill = as.numeric(pH)),width=0.25, pch=21, size=2) +
  scale_fill_gradient(low = "#ffc43d", high = "#06d6a0")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
    labs(
    x = expression(paste("Temperature ",degree,"C")),
    fill = "pH",
    y =  expression(ΔShell~growth~month^-1)) 

# diff in temp treatments
nucellagrowth %>%
  group_by(temp_treatment) %>%
  summarise(mean_value = mean(NP_change, na.rm = TRUE))

nucellagrowth %>%
  group_by(temp_treatment) %>%
  summarise(sd_value = sd(NP_change, na.rm = TRUE))

se_diff <- sqrt((0.1304387^2 / nrow(nucellagrowth %>% filter(temp_treatment == 22))) + (0.2220052^2 / nrow(nucellagrowth %>% filter(temp_treatment == 18))))

cat("Mean difference:", round(mean_diff, 3), "mm ±", round(se_diff, 3), "SE\n")
```

## Nucella Condition Index - not sig

```{r}
nucellagrowth$CI <- nucellagrowth$AFDW/nucellagrowth$dry_shell*100
nCImodel <- lm(CI ~ pH * temp_treatment, data = nucellagrowth)
#plot(mCImodel)
anova(mCImodel)

nCImodel %>% 
  ggplot(aes(x = pH, y = CI, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(Condition~Index)
  )

# averages
nucellagrowth_avg <- nucellagrowth %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_CI = mean(CI, na.rm = TRUE)  # calculate mean growth rate
  )

nCImodel_avg <- lm(avg_CI ~ pH * temp_treatment, data=nucellagrowth_avg) # model
#plot(musselweight)
anova(nCImodel_avg) # nothing sig

nCImodel_avg %>% 
  ggplot(aes(x = pH, y = avg_CI, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(Condition~Index)
  )
```

## Nucella calcification - temp effect! 
```{r}
nucella_calc <- calc %>%
  filter(Species == "Nucella") %>%
  mutate(ID = as.factor(ID)) %>%
  left_join(nucellarespo %>% 
              select(ID,pH)) %>%
  mutate(temp_treatment = as.factor(temp_treatment))

Ncalc_lm <- lm(umol.cm2.hr ~ wet_weight, data=calc)
summary(Ncalc_lm) # wet weight does not predict calc

summary(nucella_calc) # get ranges

# model calc with all interaction terms
Ncalcmodel <- lm(umol.cm2.hr ~ pH * temp_treatment, data = nucella_calc)
#plot(Ncalcmodel)
anova(Ncalcmodel) # temp sig

# normal plot
Ncalcmodel %>%
  ggplot(aes(x=pH, y=umol.cm2.hr, color = as.factor(temp_treatment),fill=as.factor(temp_treatment)))+
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  labs(x = expression(pH[T]),
       color = expression(paste("Temperature ",degree,"C")),
       fill = expression(paste("Temperature ",degree,"C")),
       y = expression(Calcification~rate~(CaCO[3]~g^-1~hr^-1)))

# averages
nucellacalc_avg <- nucella_calc %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_calc = mean(umol.cm2.hr, na.rm = TRUE)  # calculate mean growth rate
  )

ncalcmodel_avg <- lm(avg_calc ~ pH * temp_treatment, data=nucellacalc_avg) # model
#plot(musselweight)
anova(ncalcmodel_avg) # temperature 

ncalcmodel_avg %>% 
  ggplot(aes(x = pH, y = avg_calc, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(Calcification~rate~(mu*mol~CaCO[3]~g^-1~hr^-1)))

# without pH
Ncalcplot <-
ncalcmodel_avg %>% 
  ggplot(aes(x = temp_treatment, y = avg_calc)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_boxplot(alpha=0.5, outlier.alpha=0) + 
  geom_jitter(aes(fill = as.numeric(pH)),width=0.25, pch=21, size=2) +
  scale_fill_gradient(low = "#ffc43d", high = "#06d6a0")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
    labs(
    x = expression(paste("Temperature ",degree,"C")),
    fill = "pH",
     y = expression(Calcification~rate~(mu*mol~CaCO[3]~g^-1~hr^-1)))

# diff between temp treatments
nucella_calc %>%
  group_by(temp_treatment) %>%
  summarise(mean_value = mean(umol.cm2.hr, na.rm = TRUE))
```

### Nucella shell calcification
```{r}
nucella_shell_calc <- shell_calc %>%
  filter(Species == "Nucella") %>%
  group_by(pH_treatment, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_calc = mean(umol.cm2.hr, na.rm = TRUE)  # calculate mean growth rate
  )

Nshellcalcmodel_avg <- lm(avg_calc ~ pH_treatment * temp_treatment, data=nucella_shell_calc) # model
#plot(Nshellcalcmodel_avg)
anova(Nshellcalcmodel_avg) # nothin sig

Nshellplot <-
Nshellcalcmodel_avg %>% 
  ggplot(aes(x = pH_treatment, y = avg_calc, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(aes(shape = as.factor(temp_treatment)), alpha = 0.5)+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    shape = expression(paste("Temperature ",degree,"C")),
    y = expression(Calcification~rate~(mu*mol~CaCO[3]~hr^-1)))

```


## Nucella respo - temperature significant again but opposite of what i expected

```{r}
# does weight matter? no
nucrespoweight <- lm(Respiration ~ AFDW, data = nucellarespo) # does AFDW predict respiration rate?
#plot(nucrespoweight)
anova(nucrespoweight) # weight not significant

nucellarespo %>%
  ggplot(aes(x=AFDW, y=Respiration))+
  stat_summary(aes(color = as.factor(temp_treatment)), fun.args = list(mult = 1), size = 0.5) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        text = element_text(size = 14)) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00"))+ 
  labs(x = expression(Dry~Weight~(g)),
      color = expression(paste("Temperature ",degree,"C")),
      fill = expression(paste("Temperature ",degree,"C")),
      y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))

# can use raw data
nucrespomodel <- lm(Respiration ~ pH * temp_treatment, data = nucellarespo)
#plot(nucrespomodel)
anova(nucrespomodel) # temp sig

nucrespomodel %>% 
  ggplot(aes(x = pH, y = Respiration, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1))
  )

# averages
nucellarespo_avg <- nucellarespo %>%
  group_by(pH, temp_treatment) %>%  # group by temp and pH
  summarize(
    avg_respo = mean(Respiration, na.rm = TRUE)  # calculate mean growth rate
  )

nucrespoavg <- lm(avg_respo ~ pH * temp_treatment, data=nucellarespo_avg) # model
#plot(musselweight)
anova(nucrespoavg) # temperature 
summary(nucrespoavg)

nucrespoavg %>% 
  ggplot(aes(x = pH, y = avg_respo, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))

# without pH
Nrespoplot <-
nucrespoavg %>% 
  ggplot(aes(x = temp_treatment, y = avg_respo)) +
  geom_boxplot(alpha=0.5, outlier.alpha=0) + 
  geom_jitter(aes(fill = as.numeric(pH)),width=0.25, pch=21, size=2) +
  scale_fill_gradient(low = "#ffc43d", high = "#06d6a0")+
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
    labs(
    x = expression(paste("Temperature ",degree,"C")),
    fill = "pH",
    y = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))

# diff between temps
nucellarespo %>%
  group_by(temp_treatment) %>%
  summarise(mean_value = mean(Respiration, na.rm = TRUE))
```

## C:R

```{r}
nucella_avg <- nucellacalc_avg %>%
  left_join(nucellarespo_avg)

nucella_avg %>%
  ggplot(aes(x = avg_respo, y = avg_calc, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    y = expression(Calcification~rate~(mu*mol~CaCO[3]~g^-1~hr^-1)),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    x = expression(Respiration~rate~(mu*mol~O[2]~g^-1~hr^-1)))
```

# Nucella mortality
```{r}
nucellaMortality <- nucellarespo %>%
  group_by(tank) %>%
  summarise(mortalities = 5-n())
```

# Predation

## number eaten - potential increase with pH, but driven very strongly by 8.0/22
```{r}
predation <- mortality %>%
  filter(eaten == "Y") %>%
  group_by(tank) %>%
  summarise(mortalities = n()) %>%
  left_join(musselrespo %>%
            group_by(tank) %>%
            summarise(pH = mean(pH, na.rm = TRUE),
                      temp_treatment = first(temp_treatment)))  # add treatment data

predationmodel <- lm(mortalities ~ pH * temp_treatment, data = predation)
#plot(predationmodel)
anova(predationmodel) # effect of pH?

predation %>%
  ggplot(aes(x = pH, y = mortalities, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = "Mussels eaten")

```

## Biomass eaten
```{r}
predation <- mortality %>%
  filter(eaten == "Y") %>% # filter out eaten mussels
  group_by(tank) %>%
  summarise(biomass_eaten = sum(wet_weight, na.rm = TRUE)) %>% # biomass eaten per tank
  left_join(musselrespo %>%
            group_by(tank) %>%
            summarise(pH = mean(pH, na.rm = TRUE),
                      temp_treatment = first(temp_treatment)))  # add treatment data

predation_bmodel <- lm(biomass_eaten ~ pH * temp_treatment, data = predation)
shapiro.test(resid(predation_bmodel))
leveneTest(biomass_eaten ~ temp_treatment, data = predation)
plot(predation_bmodel)
anova(predation_bmodel) # nothing

#eatenplot <- 
predation %>%
  ggplot(aes(x = pH, y = biomass_eaten)) +
  geom_point(alpha = 0.5, aes(color = as.factor(temp_treatment), fill = as.factor(temp_treatment)))+
  #geom_smooth(method = "lm", se = TRUE, color = "black", fill = "gray70") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = "Biomass of mussels eaten (g)")
```

## Predation - biomass eaten standardized to control
```{r}
mortality_ctrl <- mortality %>%
  filter(cage == "ctrl") %>%
  group_by(tank) %>%
  summarise(biomass_lost = sum(wet_weight, na.rm = TRUE)) # get all the control mortality biomass per tank

predation <- mortality %>%
  filter(eaten == "Y") %>%
  group_by(tank) %>%
  summarise(biomass_eaten = sum(wet_weight, na.rm = TRUE)) %>% # biomass eaten per tank
  left_join(mortality_ctrl, by = "tank") %>%
  left_join(musselrespo %>%
              group_by(tank) %>%
              summarise(pH = mean(pH, na.rm = TRUE), # add real treatment values
temp_treatment = first(temp_treatment)),by = "tank") %>%
  replace_na(list(biomass_lost = 0)) %>%  # replace NA with 0
  mutate(eaten_lost = (biomass_eaten+1)/(biomass_lost+1)) # add 1 to get rid of 0 values

predation_b_n_model <- lm(eaten_lost ~ pH * temp_treatment, data = predation)
plot(predation_b_n_model)
anova(predation_b_n_model) # nothing

predation %>%
  ggplot(aes(x = pH, y = eaten_lost)) +
  geom_point(alpha = 0.5, aes(color = as.factor(temp_treatment), fill = as.factor(temp_treatment)))+
  geom_smooth(method = "lm", se = TRUE, color = "black", fill = "gray70") +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 18)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = "Biomass of mussels eaten (g)")
```


## Mortality
```{r}
# using count
mortality_c <- mortality %>%
  filter(cage == "ctrl") %>%
  group_by(tank) %>%
  summarise(ctrlmortality = n(), .groups = "drop") %>% # count number of mortalities per tank
  replace_na(list(ctrlmortality = 0))  # replace NA with 0

predation <- predation %>% 
  left_join(mortality_c, by = "tank") %>%
  replace_na(list(ctrlmortality = 0))  # replace NA with 0

ctrlMtest <- lm(ctrlmortality ~ pH * temp_treatment, data = predation)
#plot(predationmodel)
anova(ctrlMtest)

predation %>%
  ggplot(aes(x = pH, y = ctrlmortality, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = "Control mussels dead")

# what if we did biomass rather than count

mortalitytest <- lm(biomass_lost ~ pH * temp_treatment, data = predation)
#plot(predationmodel)
anova(mortalitytest)

predation %>%
  ggplot(aes(x = pH, y = biomass_lost, color = as.factor(temp_treatment), fill = as.factor(temp_treatment))) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
    labs(
    x = expression(pH[T]),
    color = expression(paste("Temperature ",degree,"C")),
    fill = expression(paste("Temperature ",degree,"C")),
    y = "Control mussels dead")
```

## Drilled mussels
```{r}
predation_d <- mortality %>%
  filter(eaten == "Y") %>%
  mutate(drilled = as.factor(drilled)) %>%
  group_by(tank) %>%
  dplyr::select("tank","eaten","drilled","wet_weight") %>%
  left_join(musselrespo %>%
              dplyr::select(c("tank", "pH", "temp_treatment")), by = c("tank")) # add treatment data

drilledmodelfull <- glm(drilled ~ pH * temp_treatment, family = "binomial", data = predation_d)
summary(drilledmodelfull)
anova(drilledmodelfull, test = "Chisq")

preds <- predict(drilledmodelfull, newdata = predation_d, type = "link", se.fit = TRUE)

predation_d <- predation_d %>%
  ungroup() %>%
  mutate(
    drill_prob = plogis(preds$fit),
    drill_upper = plogis(preds$fit + 1.96 * preds$se.fit),
    drill_lower = plogis(preds$fit - 1.96 * preds$se.fit)
  )

predation_d_avg <- predation_d %>%
  group_by(tank,pH,temp_treatment) %>%
  summarize(
    proportion_drilled = sum(drilled == "Y", na.rm = TRUE) / sum(eaten == "Y", na.rm = TRUE)
  )

drillplot <-
  ggplot(predation_d, aes(x = pH, color = temp_treatment, fill = temp_treatment)) +
  geom_ribbon(aes(ymin = drill_lower, ymax = drill_upper, group = temp_treatment),
              alpha = 0.2, color = NA) +
  geom_line(aes(y = drill_prob), size = 1) +  # GLM predicted line
  geom_point(data = predation_d_avg, 
             aes(x = pH, y = proportion_drilled, color = temp_treatment), 
             alpha = 0.4) + # tank proportions
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  theme_bw() +
  theme(text = element_text(size = 18)) +
  labs(
    x = expression(pH[T]),
    y = "Proportion of eaten mussels drilled", 
    color = expression(paste("Temperature ", degree, "C")), 
    fill  = expression(paste("Temperature ", degree, "C"))
  )

## rug drill plot

predation_d_rug <- augment(drilledmodelfull, type.predict = "response") # get model predictions

predation_d_rug <- predation_d_rug %>%
  mutate(Y_drill = ifelse(drilled == "Y", pH, NA), 
         N_drill = ifelse(drilled == "N", pH, NA))

predation_d_rug <- predation_d_rug %>%
  ungroup() %>%
  mutate(
    drill_prob = plogis(preds$fit),
    drill_upper = plogis(preds$fit + 1.96 * preds$se.fit),
    drill_lower = plogis(preds$fit - 1.96 * preds$se.fit)
  )

rugdrillplot<-
predation_d_rug %>%
  ggplot(aes(x = pH)) +
  geom_line(aes(y = .fitted, color = temp_treatment), size = 1) +
  geom_ribbon(aes(ymin = drill_lower, ymax = drill_upper, group = temp_treatment, fill = temp_treatment),
              alpha = 0.2) +
  labs(x = expression(pH[T]),
       y = "Mussel drilled",
       color = expression(paste("Temperature ", degree, "C")),
       fill = expression(paste("Temperature ", degree, "C"))) +
  geom_rug(aes(x = N_drill, color = temp_treatment), sides = "b", alpha = 0.2) +
  geom_rug(aes(x = Y_drill, color = temp_treatment), sides = "t", alpha = 0.2)+
  scale_color_manual(values = c("#0072B2", "#D55E00")) +
  scale_fill_manual(values = c("#0072B2", "#D55E00")) +
  theme_bw() +
  theme(text = element_text(size = 18))

```

### hungry whelks
```{r}
hungry_whelks %>% 
  ggplot(aes(x = pH, y = whelks_not_eating)) +
  geom_point(aes(color = as.factor(temp))) + 
  theme_bw()+
  theme(
    strip.background = element_rect(fill = "white"),
    text = element_text(size = 14)
  ) +
    labs(x = expression(pH[T]),
       y = "Number of whelks that did not consume mussels", 
       color = expression(paste("Temperature ",degree,"C")), 
       fill  = expression(paste("Temperature ",degree,"C")))


anova(lm(whelks_not_eating ~ pH*temp, data = hungry_whelks))
```


### patchworked graphs

```{r}
#Mrespoplot + Mcalcplot + plot_layout(guides = "collect", axes = "collect_x")

#ggsave("mytilus.png", path=here("Output"), width = 16, height = 8)

#Nrespoplot + Ncalcplot + shellgrowthplot + plot_layout(guides = "collect", axes = "collect_x")

#ggsave("nucella.png", path=here("Output"), width = 16, height = 8)

#eatenplot + rugdrillplot + plot_layout(guides = "collect", axes = "collect_x")

#ggsave("nucella predation.png", path=here("Output"), width = 16, height = 8)

#Mshellplot + Nshellplot + plot_layout(guides = "collect", axes = "collect")

#ggsave("shell calcification.png", path=here("Output"), width = 16, height = 8)

#musselweightplot + mussellengthplot + musselwidthplot + musselCIplot + plot_layout(guides = "collect", axes = "collect_x")

#ggsave("mussel no responses.png", path=here("Output"), width = 16, height = 12)
```
